---
title: mmdetection±¨´í»ã×Ü
date: 2022-07-21 19:09:42
permalink: /pages/7c1c52/
categories:
  - essay
tags:
  - 
author: 
  name: Shanya
  link: https://github.com/shanyaliux
---
# mmdetectionè®­ç»ƒæŠ¥é”™æ±‡æ

- `one of the variables needed for gradient computation has been modified by an inplace operation`

  - è¯¦ç»†æŠ¥é”™ä¿¡æ¯ï¼
    ```python
    Traceback (most recent call last):
    File "tools/train.py", line 242, in <module>
        main()
    File "tools/train.py", line 231, in main
        train_detector(
    File "/home/lgh/code/mmlab/mmdetection/mmdet/apis/train.py", line 244, in train_detector
        runner.run(data_loaders, cfg.workflow)
    File "/home/lgh/miniconda3/envs/mmlab/lib/python3.8/site-packages/mmcv/runner/epoch_based_runner.py", line 127, in run
        epoch_runner(data_loaders[i], **kwargs)
    File "/home/lgh/miniconda3/envs/mmlab/lib/python3.8/site-packages/mmcv/runner/epoch_based_runner.py", line 51, in train
        self.call_hook('after_train_iter')
    File "/home/lgh/miniconda3/envs/mmlab/lib/python3.8/site-packages/mmcv/runner/base_runner.py", line 309, in call_hook
        getattr(hook, fn_name)(self)
    File "/home/lgh/miniconda3/envs/mmlab/lib/python3.8/site-packages/mmcv/runner/hooks/optimizer.py", line 56, in after_train_iter
        runner.outputs['loss'].backward()
    File "/home/lgh/miniconda3/envs/mmlab/lib/python3.8/site-packages/torch/tensor.py", line 245, in backward
        torch.autograd.backward(self, gradient, retain_graph, create_graph, inputs=inputs)
    File "/home/lgh/miniconda3/envs/mmlab/lib/python3.8/site-packages/torch/autograd/__init__.py", line 145, in backward
        Variable._execution_engine.run_backward(
    RuntimeError: one of the variables needed for gradient computation has been modified by an inplace operation: [torch.cuda.FloatTensor [2, 2048, 25, 25]], which is output 0 of ReluBackward1, is at version 2; expected version 1 instead. Hint: enable anomaly detection to find the operation that failed to compute its gradient, with torch.autograd.set_detect_anomaly(True).
    ```

  - é—®é¢˜åˆ†æï¼  
    æ‰è°“inplaceæ“ä½œå°±æ˜¯ç›´æ¥ä¿®æ”¹åœ°å€ä¸Šçš„å€¼ã

    é¦–å…ˆæ˜¯torchä¸­æ‰€æœ‰åŠ  _ çš„å‡½æ•°ï¼Œx.squeeze_()ï¼Œx.unsqueeze_()ã€‚è¿™äº›æ“ä½œç›´æ¥ä¿®æ”¹å˜é‡ï¼Œä¸è¿”å›å¼ã

    å…¶æ¬¡ä¸äº›å‡½æ•°å¯ä»¥éšè¿‡è®¾ç½®æ˜¯å¦inplaceï¼Œæ¯”å¦‚Pytorchä¸ torch.relu()å’Œtorch.sigmoid()ç­‰æ¿€æ´»å‡½æ•°ä¸æ˜¯inplaceæ“ä½œï¼Œå…¶ä¸­ReLUå¯éšè¿‡è®¾ç½®inplace=Trueè¿›è¡Œinplaceæ“ä½œã€

    ä»¥åŠä¸äº›ç®—æœ¯æ“ä½œï¼Œx += resæ˜¯inplaceæ“ä½œï¼Œx = x + resä¸æ˜¯ã€‚ä»¥åŠä¸€äº›èµ‹å€¼æ“ä½œã

    å¦‚æœä¸äº›ç”¨äºbackwardçš„å¼è¢«inplaceæ“ä½œä¿®æ”¹äº†å°±ä¼šæŠ¥é”™ï¼Œæ‰ä»¥æœ€å¥½ä¸ä½¿ç”¨inplaceæ“ä½œï¼Œä»¥åŠå°†èµ‹å¼æ“ä½œæ”¾åœ¨å„ç§éœ€è¦è®¡ç®—æ¢¯åº¦è¿ç®—ä¹‹å‰ï¼Œgatherè¦åœ¨èµ‹å¼ä¹‹åã


  - è§£å†³æ–¹æ¡ˆï¼  
    å°†`ReLu`çš„`inplace=True`ç§»é™¤

  - å‚èƒæ–‡ç« ï¼š  
    [https://blog.csdn.net/qq_38163755/article/details/110957133](https://blog.csdn.net/qq_38163755/article/details/110957133)
